<!-- frontend/src/components/learning/FeedbackContent.vue -->
<template>
  <div v-if="feedbackData" class="feedback-content content-active">
    <h3>{{ parsedFeedback.title }}</h3>

    <div v-if="parsedFeedback.answerInfo" class="answer-info-section">
      <h4>📋 답변 정보</h4>
      <div class="details-text" v-html="parsedFeedback.answerInfo"></div>
    </div>

    <div v-if="parsedFeedback.feedbackContent" class="feedback-content-section">
      <h4>💬 상세 피드백</h4>
      <div class="details-text" v-html="parsedFeedback.feedbackContent"></div>
    </div>
    
    <div v-if="parsedFeedback.explanation" class="explanation-section">
        <h4>🧠 추가 설명</h4>
        <div class="details-text" v-html="parsedFeedback.explanation"></div>
    </div>

    <div v-if="parsedFeedback.nextStepInfo" class="next-step-section">
      <h4>🎯 다음 단계 안내</h4>
      <div class="details-text" v-html="parsedFeedback.nextStepInfo"></div>
    </div>
  </div>

  <!-- 피드백 데이터가 없을 때 로딩 상태 표시 -->
  <div v-else class="loading-state">
    <div class="loading-content">
      <div class="loading-icon">💬</div>
      <h3>피드백을 생성하고 있습니다...</h3>
      <p>답변을 평가 중입니다. 잠시만 기다려주세요.</p>
    </div>
  </div>
</template>

<script setup>
import { computed, watch } from 'vue'
import { useLearningStore } from '@/stores/learningStore'
import { storeToRefs } from 'pinia'

// --- Store 직접 연결 ---
const learningStore = useLearningStore()
// Store에서 feedbackData를 직접 가져옵니다.
const { feedbackData } = storeToRefs(learningStore)

console.log('[FeedbackContent] 🟢 컴포넌트 초기화. Store의 feedbackData와 연결되었습니다.')

const parsedFeedback = computed(() => {
  // feedbackData가 없으면 즉시 종료
  if (!feedbackData.value || !feedbackData.value.content) {
    return {}
  }

  const result = {
    title: feedbackData.value.title || '✅ 평가 결과',
    answerInfo: '',
    feedbackContent: '',
    nextStepInfo: '',
    explanation: (feedbackData.value.explanation || '').replace(/\n/g, '<br>')
  }

  let content = feedbackData.value.content
  
  const nextStepDelimiter = '🎯 **다음 단계 안내**'
  const answerInfoDelimiter = '📋 **답변 정보**'

  // 1. '다음 단계 안내' 섹션을 분리
  const nextStepIndex = content.indexOf(nextStepDelimiter)
  if (nextStepIndex !== -1) {
    result.nextStepInfo = content.substring(nextStepIndex + nextStepDelimiter.length).trim().replace(/\n/g, '<br>')
    content = content.substring(0, nextStepIndex).trim()
  }

  // 2. 남은 content에서 '답변 정보' 섹션을 분리
  const answerInfoIndex = content.indexOf(answerInfoDelimiter)
  if (answerInfoIndex !== -1) {
    result.answerInfo = content.substring(answerInfoIndex + answerInfoDelimiter.length).trim().replace(/\n/g, '<br>')
    content = content.substring(0, answerInfoIndex).trim()
  }
  
  // 3. 최종적으로 남은 content가 '상세 피드백'
  result.feedbackContent = content.replace(/^[🎉💪]\s*/, '').trim().replace(/\n/g, '<br>')

  console.log('[FeedbackContent 파싱 결과]', {
    answerInfo: result.answerInfo,
    feedbackContent: result.feedbackContent,
    nextStepInfo: result.nextStepInfo
  });

  return result
})

// 디버깅용 감시자
watch(feedbackData, (newData) => {
  if (newData) {
    console.log('[FeedbackContent] 💬 피드백 데이터가 변경되어 화면을 다시 그립니다.', newData)
  } else {
    console.log('[FeedbackContent] ⏳ 피드백 데이터가 없어 로딩 상태를 표시합니다.')
  }
}, { deep: true, immediate: true })
</script>

<style lang="scss" scoped>
.feedback-content {
  background: linear-gradient(135deg, lighten($success, 55%), lighten($success, 50%));
  border-left: 4px solid $success;
  padding: $spacing-lg;
  border-radius: $border-radius-lg;
  margin-bottom: $spacing-md;
  display: flex;
  flex-direction: column;
  gap: $spacing-md;
}
.answer-info-section,
.feedback-content-section,
.explanation-section,
.next-step-section {
  background: rgba($white, 0.8);
  border: 1px solid rgba($success, 0.3);
  border-radius: $border-radius-lg;
  padding: $spacing-md;
}
h4 {
  margin: 0 0 $spacing-md * 0.75 0;
  color: darken($success, 20%);
  font-size: $font-size-base;
  font-weight: 600;
}
.details-text {
  line-height: 1.6;
  color: darken($success, 20%);
}

/* 로딩 상태 스타일 */
.loading-state {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 300px;
  background: linear-gradient(135deg, lighten($success, 60%), lighten($success, 55%));
  border: 1px solid rgba($success, 0.2);
  border-radius: $border-radius-lg;
  padding: $spacing-lg * 2;
}

.loading-content {
  text-align: center;
  color: darken($success, 15%);
}

.loading-icon {
  font-size: 3rem;
  margin-bottom: $spacing-md;
  animation: pulse 2s infinite;
}

.loading-state h3 {
  margin: 0 0 $spacing-sm 0;
  font-size: $font-size-lg;
  color: darken($success, 20%);
}

.loading-state p {
  margin: 0;
  font-size: $font-size-base;
  color: darken($success, 15%);
  opacity: 0.8;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.1); opacity: 0.7; }
}

.content-active {
  display: block;
  animation: fadeIn 0.3s ease-in;
}
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
</style>